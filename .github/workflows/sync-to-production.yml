name: Sync to Production Repo

on:
  release:
    types: [published]  # Triggers when a release is published

jobs:
  sync-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout dev repository
        uses: actions/checkout@v4
        with:
          ref: main  # Checkout main branch explicitly
          fetch-depth: 1  # Fetch only the latest commit
          persist-credentials: false  # Don't persist the default GITHUB_TOKEN
      
      - name: Extract release version
        id: release
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Sync code and release to production repository
        env:
          PROD_REPO_TOKEN: ${{ secrets.PROD_REPO_TOKEN }}
          RELEASE_VERSION: ${{ steps.release.outputs.version }}
        run: |
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Clone production repository
          git clone https://x-access-token:${PROD_REPO_TOKEN}@github.com/Yet-Another-Research-Organisation/yetanotherspdnet.git prod_repo
          
          # Copy all files from dev to production (excluding .git)
          rsync -av --delete --exclude='.git' --exclude='prod_repo' ./ prod_repo/
          
          # Navigate to production repo
          cd prod_repo
          
          # Check if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            # Commit changes
            git add .
            git commit -m "Sync from dev: ${RELEASE_VERSION}"
            
            # Push changes
            git push origin main
            
            echo "âœ… Code synced to production repository"
          else
            echo "No changes to sync"
          fi
          
          # Delete tag if it exists (locally and remotely)
          if git rev-parse ${RELEASE_VERSION} >/dev/null 2>&1; then
            git tag -d ${RELEASE_VERSION}
            git push origin :refs/tags/${RELEASE_VERSION} || true
          fi
          
          # Create and push the tag in production repo
          git tag -a ${RELEASE_VERSION} -m "Release ${RELEASE_VERSION}"
          git push origin ${RELEASE_VERSION}
          
          echo "âœ… Release ${RELEASE_VERSION} synced to production repository"
      
      - name: Summary
        run: |
          echo "### Synchronization Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** \`${{ steps.release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** yetanotherspdnet (production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All source files and the release tag have been synced to the production repository." >> $GITHUB_STEP_SUMMARY
