name: Sync to Production Repo

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on semantic version tags like v1.0.0, v2.1.3, etc.

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout dev repository
        uses: actions/checkout@v4
        with:
          ref: main  # Checkout main branch explicitly
          fetch-depth: 1  # Fetch only the latest commit
          persist-credentials: false  # Don't persist the default GITHUB_TOKEN
      
      - name: Extract tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Sync code and tag to production repository
        env:
          PROD_REPO_TOKEN: ${{ secrets.PROD_REPO_TOKEN }}
          TAG_NAME: ${{ steps.tag.outputs.tag }}
        run: |
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Clone production repository
          git clone https://x-access-token:${PROD_REPO_TOKEN}@github.com/Yet-Another-Research-Organisation/yetanotherspdnet.git prod_repo
          
          # Copy all files from dev to production (excluding .git)
          rsync -av --delete --exclude='.git' --exclude='prod_repo' ./ prod_repo/
          
          # Navigate to production repo
          cd prod_repo
          
          # Check if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            # Commit changes
            git add .
            git commit -m "Sync from dev: ${TAG_NAME}"
            
            # Push changes
            git push origin main
            
            echo "âœ… Code synced to production repository"
          else
            echo "No changes to sync"
          fi
          
          # Create and push the tag in production repo
          git tag -a ${TAG_NAME} -m "Release ${TAG_NAME}"
          git push origin ${TAG_NAME}
          
          echo "âœ… Tag ${TAG_NAME} synced to production repository"
      
      - name: Summary
        run: |
          echo "### Synchronization Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** yetanotherspdnet (production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All source files and the version tag have been synced to the production repository." >> $GITHUB_STEP_SUMMARY
